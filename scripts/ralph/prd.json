{
  "project": "ArcFlow",
  "branchName": "ralph/power-features",
  "description": "ArcFlow Power Features v2.0 — Browsing Time Machine, Page Annotation Layer, Workspace Autopilot, Tab Relationship Graph, and AI Research Copilot. 30 stories across 5 waves.",
  "userStories": [
    {
      "id": "INFRA-01",
      "title": "Navigation Event Tracking System",
      "description": "Create an IndexedDB-backed navigation event tracking system. Every page visit gets recorded with timestamp, URL, title, tabId, transitionType (from chrome.webNavigation), and referrer tabId.",
      "priority": 1,
      "dependsOn": [],
      "filesToCreate": [
        "src/shared/navigationDb.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts",
        "src/background/service-worker.ts",
        "public/manifest.json"
      ],
      "acceptanceCriteria": [
        "NavigationEvent interface added to types.ts with fields: id, tabId, url, title, timestamp, transitionType, referrerTabId (optional), sessionId",
        "IndexedDB wrapper in navigationDb.ts with initNavigationDb(), addNavEvent(), getNavEvents(tabId), getNavEventsSince(timestamp), pruneOldEvents(maxAgeDays)",
        "chrome.webNavigation.onCommitted listener in service-worker.ts records events to IndexedDB",
        "DB opened/closed per write (no persistent connection — service worker may suspend)",
        "Events pruned after 30 days by default",
        "webNavigation permission added to manifest.json",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "INFRA-02",
      "title": "Tab Switch Affinity Tracking",
      "description": "Track which tabs the user switches between frequently. Stores switch pairs in chrome.storage.local under key tabSwitchLog. This data feeds the Tab Relationship Graph and Autopilot features.",
      "priority": 2,
      "dependsOn": [],
      "filesToCreate": [
        "src/shared/affinityStorage.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts",
        "src/background/service-worker.ts"
      ],
      "acceptanceCriteria": [
        "TabSwitchEntry interface added to types.ts: { from: number, to: number, timestamp: number }",
        "affinityStorage.ts with recordSwitch(fromTabId, toTabId), getAffinityPairs(minCount), pruneOldSwitches(maxAgeDays)",
        "Storage key is tabSwitchLog in chrome.storage.local",
        "chrome.tabs.onActivated listener in service-worker.ts calls recordSwitch() with previous and current tab IDs",
        "Switch log capped at 10,000 entries",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-T1-01",
      "title": "Time Machine Settings",
      "description": "Add Time Machine settings: enable/disable tracking, retention period (7/14/30 days), max events stored. Add prune alarm to service worker.",
      "priority": 3,
      "dependsOn": ["INFRA-01"],
      "filesToCreate": [],
      "filesToModify": [
        "src/shared/types.ts",
        "src/shared/constants.ts",
        "src/sidepanel/SettingsPanel.tsx",
        "src/background/service-worker.ts"
      ],
      "acceptanceCriteria": [
        "Settings interface extended with timeMachineEnabled: boolean, timeMachineRetentionDays: number",
        "DEFAULT_SETTINGS in constants.ts has timeMachineEnabled: true, timeMachineRetentionDays: 30",
        "SettingsPanel.tsx has Time Machine section with toggle and retention dropdown (7/14/30 days)",
        "Service worker checks timeMachineEnabled before recording navigation events",
        "Alarm pruneNavigationEvents added in onInstalled, handled in onAlarm (runs daily)",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-T1-02",
      "title": "Navigation Tree Builder",
      "description": "Build navigation trees from raw events. A tree represents a browsing session starting from a root URL, with child nodes for each page navigated from it. Trees built by matching referrerTabId chains.",
      "priority": 4,
      "dependsOn": ["INFRA-01"],
      "filesToCreate": [
        "src/shared/timeMachineStorage.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "NavTreeNode interface added to types.ts: { event: NavigationEvent, children: NavTreeNode[] }",
        "timeMachineStorage.ts exports buildNavigationTree(events: NavigationEvent[]): NavTreeNode[]",
        "timeMachineStorage.ts exports getTreesForTimeRange(start: number, end: number): Promise<NavTreeNode[]>",
        "Tree builder correctly chains parent to child via referrerTabId",
        "Orphan events (no referrer) become root nodes",
        "Trees sorted by timestamp (newest first)",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-A-01",
      "title": "Annotation Data Model & Storage",
      "description": "Create the annotation data model and storage layer. Annotations are tied to a specific URL and identified by XPath + text offset. Stored in chrome.storage.local under key annotations.",
      "priority": 5,
      "dependsOn": [],
      "filesToCreate": [
        "src/shared/annotationStorage.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "Annotation interface in types.ts: { id, url, pageTitle, type ('highlight' | 'note'), text, comment (optional), color, xpath, textOffset, textLength, fallbackScrollY, createdAt }",
        "annotationStorage.ts with saveAnnotation(a), getAnnotationsForUrl(url), deleteAnnotation(id), getAllAnnotations(), exportAnnotations(format: 'json' | 'markdown')",
        "Storage key is annotations in chrome.storage.local",
        "Export to JSON and Markdown formats",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-AP-01",
      "title": "Autopilot Rules Data Model",
      "description": "Define the autopilot rule system. Rules map conditions (time ranges, URL patterns, display count) to target workspaces. Autopilot disabled by default.",
      "priority": 6,
      "dependsOn": [],
      "filesToCreate": [],
      "filesToModify": [
        "src/shared/types.ts",
        "src/shared/constants.ts"
      ],
      "acceptanceCriteria": [
        "AutopilotRule interface: { id, name, enabled, conditions: AutopilotCondition[], targetWorkspaceId, priority, createdAt }",
        "AutopilotCondition interface: { type: 'time' | 'domain' | 'displayCount', value: string }",
        "Settings extended with autopilotEnabled: boolean, autopilotNotify: boolean",
        "DEFAULT_SETTINGS: autopilotEnabled: false, autopilotNotify: true",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-AP-02",
      "title": "Autopilot Scoring Engine",
      "description": "Implement the pure-function scoring engine that evaluates autopilot rules against current context and returns the best workspace match. Score = sum of matched conditions × rule priority.",
      "priority": 7,
      "dependsOn": ["US-AP-01"],
      "filesToCreate": [
        "src/shared/autopilotEngine.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "AutopilotContext interface: { currentTime: Date, activeTabUrl: string, displayCount: number }",
        "ScoredRule interface: { rule: AutopilotRule, score: number }",
        "autopilotEngine.ts exports scoreRules(rules, context): ScoredRule[]",
        "autopilotEngine.ts exports getBestMatch(rules, context): AutopilotRule | null",
        "Time condition checks hour ranges (e.g., '09:00-17:00')",
        "Domain condition checks URL pattern match",
        "DisplayCount condition checks screen count",
        "Returns null if no rules match",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-G-01",
      "title": "Graph Data Builder",
      "description": "Build graph data (nodes + edges) from navigation events and tab switch affinity data. Nodes = unique URLs grouped by domain. Edges = navigation links + affinity switches. Cap at 50 nodes.",
      "priority": 8,
      "dependsOn": ["INFRA-01", "INFRA-02"],
      "filesToCreate": [
        "src/shared/tabGraphStorage.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "GraphNode interface: { id, url, domain, title, visitCount, isOpen }",
        "GraphEdge interface: { source, target, weight, type: 'navigation' | 'switch' }",
        "GraphData interface: { nodes: GraphNode[], edges: GraphEdge[] }",
        "tabGraphStorage.ts exports buildGraphData(navEvents, affinityPairs, openTabs): GraphData",
        "Nodes capped at 50 (highest visitCount kept)",
        "Edges have correct type classification (navigation vs switch)",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-R-01",
      "title": "Research Mode Toggle & Page Text Capture",
      "description": "Add research mode toggle and content script that captures page text for AI analysis. Content script is a no-op until triggered by CAPTURE_PAGE_TEXT message. Page data stored in IndexedDB (pages can be 50KB+).",
      "priority": 9,
      "dependsOn": [],
      "filesToCreate": [
        "src/shared/researchDb.ts",
        "src/content/research.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts",
        "public/manifest.json",
        "vite.config.ts"
      ],
      "acceptanceCriteria": [
        "PageCapture interface: { id, url, title, text, sessionId, capturedAt, summary (optional) }",
        "ResearchSession interface: { id, name, pageIds: string[], createdAt }",
        "ServiceWorkerMessage extended with { type: 'CAPTURE_PAGE_TEXT' }",
        "SidePanelMessage extended with { type: 'PAGE_TEXT_CAPTURED', data: PageCapture }",
        "researchDb.ts with initResearchDb(), savePageCapture(), getCaptures(sessionId), deleteSession(sessionId)",
        "Content script research.ts extracts document.body.innerText only when messaged",
        "Content script registered in manifest.json (all URLs, run_at: document_idle)",
        "Vite config updated with research content script entry point",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-A-02",
      "title": "Content Script Annotation Toolbar",
      "description": "Create the annotation content script that injects a floating toolbar on text selection. Toolbar has Highlight (3 colors: yellow, green, blue) and Note buttons. Creates Annotation objects with XPath of selection range. Imperative DOM only — no React.",
      "priority": 10,
      "dependsOn": ["US-A-01"],
      "filesToCreate": [
        "src/content/annotate.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts",
        "src/background/service-worker.ts",
        "public/manifest.json",
        "vite.config.ts"
      ],
      "acceptanceCriteria": [
        "Floating toolbar appears on text selection with Highlight and Note buttons",
        "3 highlight colors available: yellow (#FFEB3B), green (#81C784), blue (#64B5F6)",
        "Note button opens inline text input for comment",
        "XPath + fallback scrollY captured for each annotation",
        "Annotations saved via SAVE_ANNOTATION message to service worker",
        "ServiceWorkerMessage extended with SAVE_ANNOTATION and DELETE_ANNOTATION types",
        "Service worker handles SAVE_ANNOTATION and DELETE_ANNOTATION messages",
        "Toolbar dismissed on click outside",
        "Content script registered in manifest.json and vite.config.ts",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-AP-03",
      "title": "Autopilot Background Worker",
      "description": "Wire the autopilot scoring engine into the service worker. Evaluate rules on 5-minute alarm. Show notification before switching with 5s delay (cancellable). Handle AUTOPILOT_UNDO to revert.",
      "priority": 11,
      "dependsOn": ["US-AP-02"],
      "filesToCreate": [],
      "filesToModify": [
        "src/shared/types.ts",
        "src/background/service-worker.ts",
        "public/manifest.json"
      ],
      "acceptanceCriteria": [
        "ServiceWorkerMessage extended with AUTOPILOT_SWITCH and AUTOPILOT_UNDO types",
        "evaluateAutopilot alarm added (every 5 minutes)",
        "On alarm: load rules + context, run scoring engine, switch if best match differs from current workspace",
        "Notification shown before switching (if autopilotNotify enabled)",
        "5-second delay before actual switch (user can cancel)",
        "AUTOPILOT_UNDO reverts to previous workspace",
        "No-op when autopilotEnabled is false",
        "notifications permission added to manifest.json",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-G-02",
      "title": "Graph Layout Hook (Force-Directed SVG)",
      "description": "Create a React hook that computes force-directed layout positions for graph nodes. Simple algorithm: repulsion between all nodes, attraction along edges. Runs 100 iterations on mount.",
      "priority": 12,
      "dependsOn": ["US-G-01"],
      "filesToCreate": [
        "src/sidepanel/useGraphLayout.ts"
      ],
      "filesToModify": [
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "LayoutResult interface: { nodes: Array<GraphNode & { x, y }>, edges: Array<GraphEdge & { x1, y1, x2, y2 }> }",
        "useGraphLayout(data: GraphData, width: number, height: number) hook",
        "Force-directed algorithm with repulsion between all nodes + attraction along edges",
        "Runs 100 iterations synchronously on mount",
        "Nodes stay within bounds (0 to width, 0 to height)",
        "Returns stable positioned nodes and edges",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": true
    },
    {
      "id": "US-R-02",
      "title": "Auto-Summarization via AI",
      "description": "Wire page captures to OpenRouter AI for automatic summarization. Uses same API pattern as aiGroupingService.ts. Enforces 2s minimum gap between API calls.",
      "priority": 13,
      "dependsOn": ["US-R-01"],
      "filesToCreate": [
        "src/shared/aiResearchService.ts"
      ],
      "filesToModify": [
        "src/background/service-worker.ts",
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "aiResearchService.ts exports summarizePage(text: string): Promise<string>",
        "aiResearchService.ts exports connectPages(summaries: string[]): Promise<string>",
        "aiResearchService.ts exports generateBrief(summaries: string[], topic: string): Promise<string>",
        "Follows OpenRouter API pattern from aiGroupingService.ts (same base URL, auth, model)",
        "2-second minimum gap between API calls (rate limiter)",
        "On PAGE_TEXT_CAPTURED message, service worker calls summarizePage() and stores summary alongside capture",
        "summary field added as optional to PageCapture interface",
        "Handles API errors gracefully (logs error, does not crash)",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-T1-03",
      "title": "Timeline View Section",
      "description": "Create the Time Machine sidebar section showing a chronological timeline of navigation trees. Collapsible section, date range selector (today/yesterday/this week), tree nodes with favicon + title + time, click to open URL.",
      "priority": 14,
      "dependsOn": ["US-T1-02"],
      "filesToCreate": [
        "src/sidepanel/TimeMachineSection.tsx"
      ],
      "filesToModify": [
        "src/sidepanel/App.tsx",
        "src/sidepanel/commandRegistry.ts"
      ],
      "acceptanceCriteria": [
        "Collapsible sidebar section titled 'Time Machine'",
        "Date range selector: today, yesterday, this week",
        "Tree nodes show favicon + title (truncated) + time",
        "Click tree node opens URL in new tab",
        "Expand/collapse tree branches",
        "Reacts to chrome.storage.onChanged for live updates",
        "'Time Machine' command registered in commandRegistry.ts",
        "Section rendered in App.tsx",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-A-03",
      "title": "Annotation Highlight Rendering",
      "description": "Render saved annotations on page load. Re-highlight text by locating XPath target and applying <mark> wrapper. For notes, add indicator icon. If XPath fails, fall back to scrollY with floating indicator.",
      "priority": 15,
      "dependsOn": ["US-A-02"],
      "filesToCreate": [],
      "filesToModify": [
        "src/content/annotate.ts",
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "On page load, content script queries annotations for current URL",
        "Highlights rendered as <mark> wrappers with stored color",
        "Note indicators visible on annotated text",
        "XPath fallback to scrollY with floating indicator when XPath fails",
        "ServiceWorkerMessage extended with GET_ANNOTATIONS type",
        "SidePanelMessage extended with ANNOTATIONS_LOADED type",
        "Does not break page layout",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-A-04",
      "title": "Annotations Sidebar Section",
      "description": "Create the Annotations sidebar section showing all annotations grouped by page. Each entry shows page title, annotation count, last annotated date. Expand to see individual annotations. Delete button per annotation.",
      "priority": 16,
      "dependsOn": ["US-A-01"],
      "filesToCreate": [
        "src/sidepanel/AnnotationsSection.tsx"
      ],
      "filesToModify": [
        "src/sidepanel/App.tsx",
        "src/sidepanel/commandRegistry.ts"
      ],
      "acceptanceCriteria": [
        "Collapsible sidebar section titled 'Annotations'",
        "Annotations grouped by page URL",
        "Each group shows page title + annotation count + last annotated date",
        "Expand group to see individual annotations with color indicator + text snippet + optional comment",
        "Delete button per annotation",
        "Empty state message when no annotations exist",
        "'Annotations' command registered in commandRegistry.ts",
        "Section rendered in App.tsx",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-AP-04",
      "title": "Autopilot Settings UI",
      "description": "Add Autopilot settings section to SettingsPanel with rule management. Rule editor: name, conditions (time range, domain pattern, display count), target workspace dropdown, priority.",
      "priority": 17,
      "dependsOn": ["US-AP-01"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/SettingsPanel.tsx"
      ],
      "acceptanceCriteria": [
        "Autopilot section in SettingsPanel with enable/disable toggle",
        "Notification preference toggle",
        "Rules list with add/edit/delete functionality",
        "Rule editor with name, conditions (time range, domain pattern, display count), target workspace dropdown, priority",
        "Target workspace dropdown populated from existing workspaces",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-G-03",
      "title": "Graph SVG Visualization Component",
      "description": "Create the Tab Relationship Graph sidebar section with inline SVG. Nodes are circles colored by domain, edges are lines with opacity by weight. Click node to switch tab or open URL. Hover tooltip with title + visit count.",
      "priority": 18,
      "dependsOn": ["US-G-02"],
      "filesToCreate": [
        "src/sidepanel/TabGraphSection.tsx"
      ],
      "filesToModify": [
        "src/sidepanel/App.tsx",
        "src/sidepanel/commandRegistry.ts"
      ],
      "acceptanceCriteria": [
        "Collapsible sidebar section titled 'Tab Graph'",
        "SVG graph renders nodes as circles colored by domain",
        "Edge opacity reflects weight",
        "Click node switches to tab (if open) or opens URL",
        "Hover tooltip shows full title + visit count",
        "Handles 0 nodes gracefully with empty state",
        "'Tab Graph' command registered in commandRegistry.ts",
        "Section rendered in App.tsx",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-R-03",
      "title": "Research Copilot Sidebar Section",
      "description": "Create the Research Copilot sidebar section. Start/stop research session. 'Capture This Page' button triggers content script on active tab. Shows captured pages with summaries. Session history list.",
      "priority": 19,
      "dependsOn": ["US-R-02"],
      "filesToCreate": [
        "src/sidepanel/ResearchCopilotSection.tsx"
      ],
      "filesToModify": [
        "src/sidepanel/App.tsx",
        "src/sidepanel/commandRegistry.ts"
      ],
      "acceptanceCriteria": [
        "Collapsible sidebar section titled 'Research Copilot'",
        "'Start Research' button creates new session",
        "'Capture This Page' button triggers content script on active tab",
        "Captured pages shown with title + summary",
        "'Stop Research' ends session",
        "Session history list (collapsed by default)",
        "'Research Copilot' command registered in commandRegistry.ts",
        "Section rendered in App.tsx",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-T1-04",
      "title": "Restore Tab State from Timeline",
      "description": "Add 'Restore' action to timeline nodes that re-opens all URLs from root to that node in a new window (recreating the browsing path). Confirmation dialog for >5 tabs.",
      "priority": 20,
      "dependsOn": ["US-T1-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/TimeMachineSection.tsx"
      ],
      "acceptanceCriteria": [
        "Restore button/icon appears on tree node hover",
        "Click opens all URLs from root to selected node in a new window",
        "Confirmation dialog shown when restoring >5 tabs",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-T1-05",
      "title": "Branching Tree Visualization",
      "description": "Add visual tree/branch view with CSS connector lines (border-left + pseudo-elements). 16px depth indentation. Animated expand/collapse.",
      "priority": 21,
      "dependsOn": ["US-T1-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/TimeMachineSection.tsx"
      ],
      "acceptanceCriteria": [
        "CSS connector lines between parent and children nodes",
        "Depth indentation at 16px per level",
        "Branch points visually highlighted",
        "Animated expand/collapse transitions",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-T1-06",
      "title": "Search and Filter Timeline",
      "description": "Add search/filter to Time Machine section. Search input filters by title/URL (case-insensitive). Domain filter dropdown. Matching nodes highlighted, non-matching hidden. Debounced 300ms.",
      "priority": 22,
      "dependsOn": ["US-T1-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/TimeMachineSection.tsx"
      ],
      "acceptanceCriteria": [
        "Search input at top filters tree nodes by title or URL",
        "Case-insensitive substring match",
        "Domain filter dropdown",
        "Matching nodes highlighted, non-matching collapsed/hidden",
        "Search debounced at 300ms",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-T1-07",
      "title": "Export Timeline as Markdown",
      "description": "Export navigation trees as formatted Markdown. Tree structure with indentation, links as [title](url) (HH:MM). Copies to clipboard with toast notification.",
      "priority": 23,
      "dependsOn": ["US-T1-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/TimeMachineSection.tsx"
      ],
      "acceptanceCriteria": [
        "Export button on Time Machine section header",
        "Markdown format with tree indentation using dashes",
        "Links formatted as [title](url)",
        "Timestamps included as (HH:MM)",
        "Copied to clipboard with toast notification",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-A-05",
      "title": "Scroll-to-Annotation from Sidebar",
      "description": "Click annotation in sidebar navigates to page and scrolls to annotation location. If tab open, switch and scroll. If not, open then scroll. Smooth scroll + brief highlight pulse.",
      "priority": 24,
      "dependsOn": ["US-A-03", "US-A-04"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/AnnotationsSection.tsx",
        "src/content/annotate.ts",
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "Click annotation in sidebar scrolls to it on page",
        "If tab with URL is open, switch to it and send SCROLL_TO_ANNOTATION message",
        "If not open, open URL in new tab then scroll after load",
        "Smooth scroll animation to annotation",
        "Brief highlight pulse (CSS animation) on target annotation",
        "SCROLL_TO_ANNOTATION message type added to types.ts",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-A-06",
      "title": "Export Annotations",
      "description": "Export all annotations as JSON or Markdown from sidebar. JSON downloads as .json file. Markdown grouped by page with highlights as blockquotes and color emoji prefix.",
      "priority": 25,
      "dependsOn": ["US-A-04"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/AnnotationsSection.tsx"
      ],
      "acceptanceCriteria": [
        "Export dropdown with JSON and Markdown options",
        "JSON option downloads as .json file",
        "Markdown option copies to clipboard",
        "Markdown: grouped by page, highlights as > blockquotes with color emoji prefix, notes below",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-AP-05",
      "title": "Autopilot Undo & Learning Mode",
      "description": "Undo banner in sidebar when autopilot switches workspace (10s countdown). Learning mode tracks manual switches and suggests rules after 5+ consistent patterns.",
      "priority": 26,
      "dependsOn": ["US-AP-03", "US-AP-04"],
      "filesToCreate": [
        "src/sidepanel/AutopilotBanner.tsx"
      ],
      "filesToModify": [
        "src/sidepanel/App.tsx",
        "src/background/service-worker.ts",
        "src/shared/types.ts"
      ],
      "acceptanceCriteria": [
        "AutopilotBanner.tsx shows 'Switched to {workspace} — Undo' with 10s countdown",
        "Undo button sends AUTOPILOT_UNDO message to revert workspace",
        "Banner auto-dismisses after countdown",
        "autopilotLearning: boolean added to Settings interface",
        "Service worker tracks manual workspace switches in learning mode",
        "After 5+ consistent manual switches to same workspace at same time/domain, suggests a rule",
        "Banner rendered in App.tsx",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-G-04",
      "title": "Cluster Actions (Create Folder, AI Summarize)",
      "description": "Right-click on graph node cluster (same domain group) shows context menu: Create Folder groups tabs, AI Summarize generates cluster summary. Uses existing folderStorage.ts and aiGroupingService.ts.",
      "priority": 27,
      "dependsOn": ["US-G-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/TabGraphSection.tsx"
      ],
      "acceptanceCriteria": [
        "Right-click context menu on node clusters (same domain group)",
        "'Create Folder' option creates folder with cluster tabs using folderStorage.ts",
        "'AI Summarize' option sends page titles/URLs to AI for cluster summary using aiGroupingService.ts",
        "Context menu dismissed on click outside",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-G-05",
      "title": "Graph List Fallback Toggle",
      "description": "Toggle between SVG graph view and flat list view. List shows nodes sorted by visit count with domain grouping headers. View preference persisted.",
      "priority": 28,
      "dependsOn": ["US-G-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/TabGraphSection.tsx"
      ],
      "acceptanceCriteria": [
        "Toggle button switches between graph and list icons",
        "List view shows nodes sorted by visit count",
        "Domain grouping headers in list view",
        "Same click behavior as graph (switch to tab or open URL)",
        "View preference persisted in chrome.storage.local",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-R-04",
      "title": "Cross-Page Analysis",
      "description": "Analyze connections across captured pages in research session. 'Analyze Connections' button (enabled when >=2 pages). Shows common themes, contradictions, knowledge gaps. Results cached per session.",
      "priority": 29,
      "dependsOn": ["US-R-03"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/ResearchCopilotSection.tsx"
      ],
      "acceptanceCriteria": [
        "'Analyze Connections' button disabled with <2 captured pages",
        "Calls connectPages() from aiResearchService.ts",
        "Shows results card with common themes, contradictions, and knowledge gaps",
        "Results cached in session (no re-fetch on re-render)",
        "Loading state shown during analysis",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    },
    {
      "id": "US-R-05",
      "title": "Generate Research Brief",
      "description": "Generate comprehensive research brief from captured pages. Optional topic input. Formatted output with Summary, Key Findings, Sources. Copy to clipboard and export as Markdown.",
      "priority": 30,
      "dependsOn": ["US-R-04"],
      "filesToCreate": [],
      "filesToModify": [
        "src/sidepanel/ResearchCopilotSection.tsx"
      ],
      "acceptanceCriteria": [
        "'Generate Brief' button enabled when >=1 page captured",
        "Optional topic input for focused brief",
        "Calls generateBrief() from aiResearchService.ts",
        "Formatted output with Summary, Key Findings, Sources sections",
        "Copy to clipboard button",
        "Export as Markdown option",
        "npm run typecheck passes",
        "npm run test:run passes"
      ],
      "passes": false
    }
  ]
}
