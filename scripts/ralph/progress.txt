# Ralph Progress Log
Started: Fri Feb 20 12:01:29 IST 2026
---

## Codebase Patterns
- AI service is in `src/shared/aiGroupingService.ts` — exports `getAIGroupingSuggestions(tabs, openRouterApiKey)` consumed by `OrganizeTabsModal.tsx`
- Settings type is in `src/shared/types.ts` — `Settings` interface defines all extension settings
- Settings now uses `openRouterApiKey: string` (flat field) instead of old nested `aiGrouping` object
- `settingsStorage.ts` has `migrateSettings()` that converts old `aiGrouping.apiKey` → `openRouterApiKey`
- OpenRouter API uses OpenAI-compatible response format (`data.choices[0].message.content`)
- Typecheck: `npx tsc --noEmit`, Lint: `npx eslint <file>`
- SettingsPanel.tsx uses local component pattern (e.g., `TestConnectionButton`) for self-contained UI sections
- Routing engine is in `src/shared/routingEngine.ts` — exports `matchRoute(url, rules)` for URL-to-workspace matching
- `RoutingRule` type has `enabled` field — always check it when iterating rules
- `settingsStorage.ts` migration adds `enabled: true` to old rules missing the field
- Service worker `getWorkspaceForUrl` now delegates to `matchRoute` from routingEngine.ts
- `isIgnoredUrl()` helper in service worker filters chrome://, extension://, about:blank, newtab URLs
- `ServiceWorkerMessage` type union in types.ts — add new message types here for service worker → sidepanel communication
- Auto-routing sends `tab-auto-routed` message to sidepanel when a tab is moved to a different workspace
- SettingsPanel uses local DndContext inside `RoutingRulesSection` for sortable routing rules (separate from App.tsx DndContext)
- Self-contained settings components pattern: `TestConnectionButton`, `RoutingRulesSection`, `SortableRoutingRuleRow` are all local to SettingsPanel.tsx
- App.tsx has a `toast` state with auto-dismiss (3s) — use `setToast("message")` for ephemeral notifications
- Toast renders as fixed bottom-center overlay with `animate-fade-in` (defined in index.css)
- Context menu items can be async — `onClick` handler supports `async () => {}` pattern
- To add routing rules from code: `getSettings()` → check existing → `updateSettings({ routingRules: [...existing, newRule] })`
- App.tsx message listener is mount-once (`[]` deps) — use `useRef` + `useEffect` to access changing state (e.g., `activeWorkspaceIdRef`)

---

## 2026-02-20 - US-001
- Replaced Anthropic and OpenAI API backends with single OpenRouter.ai backend
- Single function `callOpenRouterAPI` replaces `callAnthropicAPI` and `callOpenAIAPI`
- Endpoint: `https://openrouter.ai/api/v1/chat/completions`, model: `google/gemini-2.0-flash-001`
- Headers: Authorization Bearer, Content-Type application/json, HTTP-Referer chrome-extension://arcflow
- 10-second timeout via AbortController preserved
- Fallback to heuristic grouping on failure preserved
- Removed provider check — no longer needed since there's a single backend
- Files changed: `src/shared/aiGroupingService.ts`
- **Learnings for future iterations:**
  - The `settings.aiGrouping` parameter still has `provider` field — US-002 will clean this up
  - OpenRouter uses OpenAI-compatible response format, so `data.choices[0].message.content` works
  - The `enabled` check in `getAIGroupingSuggestions` still guards against calls when AI is disabled
---

## Iteration 1 - Fri Feb 20 12:03:22 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260220-120129/iter-1.log
---
US-001 is complete. There are still 29 stories with `passes: false`, so more iterations are needed.

**US-001 Summary:**
- Replaced `callAnthropicAPI` and `callOpenAIAPI` with a single `callOpenRouterAPI` function
- Endpoint: `https://openrouter.ai/api/v1/chat/completions` with model `google/gemini-2.0-flash-001`
- Headers: `Authorization: Bearer <key>`, `Content-Type: application/json`, `HTTP-Referer: chrome-extension://arcflow`
- 10-second timeout via AbortController preserved
- Fallback to heuristic grouping on failure preserved
- Error logged to console with descriptive message
- Typecheck passes, lint passes
- Committed: `ef7376d`
---

## 2026-02-20 - US-002
- Replaced nested `aiGrouping` settings with flat `openRouterApiKey: string` field
- Removed provider dropdown (anthropic/openai) from SettingsPanel
- Added single "OpenRouter API Key" password input field
- Added "Test Connection" button that calls OpenRouter with minimal prompt and shows green checkmark/red X
- Updated `Settings` type in `shared/types.ts`
- Updated `DEFAULT_SETTINGS` in `constants.ts`, removed `AI_PROVIDER_OPTIONS`
- Added migration in `settingsStorage.ts` that converts old `aiGrouping.apiKey` → `openRouterApiKey`
- Updated `aiGroupingService.ts` to accept `openRouterApiKey: string` directly
- Updated `OrganizeTabsModal.tsx` to pass `settings.openRouterApiKey` instead of `settings.aiGrouping`
- Files changed: `src/shared/types.ts`, `src/shared/constants.ts`, `src/shared/settingsStorage.ts`, `src/shared/aiGroupingService.ts`, `src/sidepanel/SettingsPanel.tsx`, `src/sidepanel/OrganizeTabsModal.tsx`
- **Learnings for future iterations:**
  - Settings migration runs on every `getSettings()` call — lightweight but handles legacy data transparently
  - `TestConnectionButton` is a self-contained component within SettingsPanel (not exported)
  - AI grouping is now implicitly enabled whenever `openRouterApiKey` is non-empty (no separate toggle)
---

## Iteration 2 - Fri Feb 20 12:06:49 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260220-120129/iter-2.log
---
**US-002 is complete.** Committed as `70d7f87`. There are still 28 stories with `passes: false`, so more iterations are needed.

**US-002 Summary:**
- Replaced nested `aiGrouping` settings object with flat `openRouterApiKey: string` field
- Removed provider dropdown (Anthropic/OpenAI) from SettingsPanel
- Added single "OpenRouter API Key" password input field
- Added "Test Connection" button that calls OpenRouter with a minimal prompt (`Say hi`, max_tokens: 5) and shows green checkmark on success, red X with error on failure
- Updated `Settings` type, `DEFAULT_SETTINGS`, removed `AI_PROVIDER_OPTIONS`
- Added migration in `settingsStorage.ts` that converts old `aiGrouping.apiKey` → `openRouterApiKey`
- Updated `aiGroupingService.ts` and `OrganizeTabsModal.tsx` callers
- Typecheck passes
---

## 2026-02-20 - US-003
- Created `src/shared/routingEngine.ts` with `matchRoute(url, rules)` function
- Added `RoutingRule` type to `src/shared/types.ts` with `{pattern, workspaceId, enabled}` fields
- Updated `Settings.routingRules` to use `RoutingRule[]` (added `enabled` field)
- Glob-to-regex conversion: `**` matches everything, `*` matches anything except `/`
- Pattern matched against URL without protocol, and also full URL for `*://` patterns
- Updated service worker `getWorkspaceForUrl` to skip disabled rules
- Updated SettingsPanel "Add Rule" to include `enabled: true`
- Added migration in `settingsStorage.ts` to backfill `enabled: true` on old rules
- Files changed: `src/shared/routingEngine.ts` (new), `src/shared/types.ts`, `src/shared/settingsStorage.ts`, `src/sidepanel/SettingsPanel.tsx`, `src/background/service-worker.ts`
- **Learnings for future iterations:**
  - Service worker has its own `globToRegex` that could be replaced with `matchRoute` from routingEngine — future stories (US-004) should consider this
  - The `matchRoute` function strips protocol before matching, so patterns like `github.com/*` work against `https://github.com/repo`
  - Patterns with `*://` prefix are matched against the full URL
---

## Iteration 3 - Fri Feb 20 12:09:00 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260220-120129/iter-3.log
---
**US-003 is complete.** Committed as `af1f3cd`. There are still 27 stories with `passes: false`, so more iterations are needed.

**US-003 Summary:**
- Created `src/shared/routingEngine.ts` with `matchRoute(url, rules)` — glob pattern matching engine for URL-to-workspace routing
- Added `RoutingRule` type to `types.ts` with `{pattern, workspaceId, enabled}` fields
- Glob conversion: `**` matches everything (including `/`), `*` matches anything except `/`
- Pattern matched against URL with protocol stripped, plus full URL for `*://` patterns
- First matching enabled rule wins; disabled rules skipped; returns `null` if no match
- Updated service worker, SettingsPanel, and settingsStorage migration for the new `enabled` field
- Typecheck passes, lint passes
---

## 2026-02-20 - US-004
- Wired auto-routing into service worker `chrome.tabs.onUpdated` listener
- Replaced local `globToRegex` with shared `matchRoute` from `routingEngine.ts` in `getWorkspaceForUrl`
- Added `isIgnoredUrl()` helper to filter chrome://, extension://, about:blank, and newtab URLs
- `onUpdated` now triggers on `status === 'complete'` (not just URL change), calls `matchRoute`, checks if tab is already in target workspace
- Sends `tab-auto-routed` message to sidepanel with tabId and workspaceId when a tab is auto-routed
- Added `tab-auto-routed` message type to `ServiceWorkerMessage` union in types.ts
- Files changed: `src/background/service-worker.ts`, `src/shared/types.ts`
- **Learnings for future iterations:**
  - `isIgnoredUrl()` can be reused for future tab event handlers that need to skip internal URLs
  - The `tab-auto-routed` message is consumed by sidepanel — US-007 will add the UI indicator
  - `getWorkspaceForUrl` now delegates to `matchRoute`, eliminating the duplicate glob logic
---

## Iteration 4 - Fri Feb 20 12:11:04 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260220-120129/iter-4.log
---
**US-004 is complete.** Committed as `cebb2b1`. There are still 26 stories with `passes: false`, so more iterations are needed.

**US-004 Summary:**
- Wired auto-routing into service worker `chrome.tabs.onUpdated` listener
- Replaced local `globToRegex` with shared `matchRoute` from `routingEngine.ts` — eliminating duplicate glob logic
- Added `isIgnoredUrl()` helper to filter `chrome://`, `extension://`, `about:blank`, and newtab URLs
- `onUpdated` now triggers on `status === 'complete'`, calls `matchRoute`, checks if tab is already in target workspace before moving
- Sends `tab-auto-routed` message to sidepanel with `tabId` and `workspaceId`
- Added `tab-auto-routed` message type to `ServiceWorkerMessage` union in `types.ts`
- Files changed: `src/background/service-worker.ts`, `src/shared/types.ts`
- Typecheck passes, lint passes
---

## 2026-02-20 - US-005
- Replaced old "Air Traffic Control" inline-edit section with new "Auto-routing" section using dedicated components
- Created `SortableRoutingRuleRow` component — each rule row shows drag handle, pattern text, workspace emoji+name badge, enable/disable toggle, and delete (X) button
- Created `RoutingRulesSection` component — self-contained section with DndContext for drag-and-drop reordering of rules
- "Add Rule" button opens inline form with pattern input (placeholder: `e.g., github.com/*`) and workspace dropdown, with Save/Cancel buttons
- Rules reorderable via @dnd-kit drag handles using `SortableContext` + `verticalListSortingStrategy`
- Toggle switch enables/disables individual rules (updates `enabled` field)
- Rules saved to `settings.routingRules` on add/toggle/delete/reorder
- Files changed: `src/sidepanel/SettingsPanel.tsx`
- **Learnings for future iterations:**
  - SettingsPanel now has its own DndContext inside `RoutingRulesSection` — this is separate from App.tsx's DndContext and works independently
  - The `SortableRoutingRuleRow` pattern (sortable row with inline controls) can be reused for other sortable settings lists
  - `RoutingRule` type imported from `shared/types.ts` — already has `enabled` field from US-003
---

## Iteration 5 - Fri Feb 20 12:13:54 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260220-120129/iter-5.log
---
**US-005 is complete.** Committed as `2d902f6`. There are still 25 stories with `passes: false`, so more iterations are needed.

**US-005 Summary:**
- Replaced the old "Air Traffic Control" inline-edit section with a new "Auto-routing" section
- Created `SortableRoutingRuleRow` component: each rule row shows drag handle, pattern text, workspace emoji+name, enable/disable toggle, and delete button
- Created `RoutingRulesSection` component: self-contained section with its own DndContext for drag-and-drop reordering
- "Add Rule" opens inline form with pattern input (`e.g., github.com/*` placeholder) and workspace dropdown
- Rules reorderable via @dnd-kit drag handles
- Toggle switches enable/disable individual rules
- All CRUD operations (add/toggle/delete/reorder) save to `settings.routingRules`
- Typecheck passes, lint passes
- File changed: `src/sidepanel/SettingsPanel.tsx`
---

## 2026-02-20 - US-006
- Added "Always open [domain] here" context menu item for tabs in App.tsx
- Extracts domain from tab URL via `new URL(tab.url).hostname`
- Creates routing rule with pattern `*://domain/*` for the active workspace
- Checks for existing rule with same pattern before adding (shows "Rule already exists" toast)
- Shows success toast: "Tabs from [domain] will auto-route to [emoji] [name]"
- Added toast notification system to App.tsx: `toast` state with 3-second auto-dismiss
- Toast renders as fixed bottom-center overlay with fade-in animation
- Skips chrome:// and extension:// domains (no menu item shown)
- Files changed: `src/sidepanel/App.tsx`
- **Learnings for future iterations:**
  - App.tsx now has a reusable toast system — `setToast("message")` for any ephemeral notification
  - Context menu `onClick` handlers can be async — useful for storage operations
  - `getSettings()` must be called at click time (not menu render time) to get fresh routing rules
  - `animate-fade-in` CSS class is already defined in `index.css` — reuse it for entry animations
---

## Iteration 6 - Fri Feb 20 12:17:44 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260220-120129/iter-6.log
---
**US-006 is complete.** Committed as `4c218e1`. There are still 24 stories with `passes: false`, so more iterations are needed.

**US-006 Summary:**
- Added "Always open [domain] here" context menu item to tab right-click menu in `App.tsx`
- Extracts domain from tab URL, creates `*://domain/*` routing rule for the active workspace
- Checks for existing rule before adding — shows "Rule already exists for [domain]" toast if duplicate
- Shows success toast: "Tabs from [domain] will auto-route to [emoji] [name]"
- Added reusable toast notification system to App.tsx (3-second auto-dismiss, fixed bottom-center)
- Skips chrome:// and extension:// domains
- Typecheck passes, lint passes
- File changed: `src/sidepanel/App.tsx`
---

## 2026-02-20 - US-007
- Added auto-routing indicator banner in App.tsx below the search bar
- Listens for `tab-auto-routed` message from service worker via existing `handleMessage` listener
- Uses `activeWorkspaceIdRef` (ref updated via useEffect) to check workspace match inside the mount-once listener
- Banner shows workspace emoji + name: "Tab auto-routed to [emoji] [name]"
- Banner auto-fades after 3 seconds via useEffect timer
- Banner has small X button to dismiss immediately
- Only shows if user is currently viewing the target workspace
- Styled with accent color bg tint, rounded corners, and `animate-fade-in` animation
- Files changed: `src/sidepanel/App.tsx`
- **Learnings for future iterations:**
  - The message listener in App.tsx is set up once with `[]` dependency — use refs to access changing state inside it
  - `getWorkspaces()` can be called inside the message handler to get fresh workspace data (name, emoji)
  - `animate-fade-in` class from `index.css` works well for entry animations on banners
---
