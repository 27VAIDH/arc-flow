# Ralph Progress Log
Started: Tue Feb 24 18:49:55 IST 2026
---

## Codebase Patterns
- Storage: Chrome Storage API (chrome.storage.local) for most data; IndexedDB for large/frequent data (navigation events)
- Service worker opens/closes DB per write (no persistent connection — worker may suspend)
- Alarms registered in chrome.runtime.onInstalled, handled in chrome.alarms.onAlarm listener
- All alarm handlers use .catch(() => {}) for silent failure with retry on next alarm
- Message types defined as discriminated unions in types.ts (ServiceWorkerMessage, SidePanelMessage)
- crypto.randomUUID() available in service worker for generating IDs
- chrome.webNavigation.onCommitted fires before page title is available; title fetched via chrome.tabs.get()
- chrome.storage.local.get() returns Record<string, any> — cast results explicitly to avoid TS errors
- Tab switch tracking uses undirected pairs (A→B and B→A count together) for affinity
- Settings toggle pattern: use `handleUpdate({ field: !settings.field })` with toggle button styling from existing sections
- TIME_MACHINE_RETENTION_OPTIONS constant in constants.ts for dropdown (7/14/30 days)
- pruneOldEvents() in navigationDb.ts accepts optional maxAgeDays parameter (defaults to 30)
- Tree building: chain events via referrerTabId; best parent = most recent event on referrer tab before child's timestamp
- getNavEventsSince() returns all events from a timestamp; filter client-side for end bound

## 2026-02-24 - INFRA-01
- Implemented IndexedDB-backed navigation event tracking system
- Files created: src/shared/navigationDb.ts
- Files modified: src/shared/types.ts, src/background/service-worker.ts, public/manifest.json
- **Learnings for future iterations:**
  - IndexedDB must be opened/closed per operation since service workers can suspend
  - chrome.webNavigation.onCommitted fires for subframes too — filter by frameId === 0
  - Page title not available at onCommitted time; need chrome.tabs.get() which may fail if tab closed
  - Skip chrome://, chrome-extension://, and about: URLs from tracking
  - Session ID is regenerated on service worker restart (using crypto.randomUUID())
---

## Iteration 1 - Tue Feb 24 18:53:49 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-184955/iter-1.log
---
INFRA-01 is complete. There are still stories with `passes: false` remaining (INFRA-02 is next at priority 2).

**INFRA-01 Summary:**
- Added `NavigationEvent` interface to `types.ts`
- Created `src/shared/navigationDb.ts` with IndexedDB wrapper (`initNavigationDb`, `addNavEvent`, `getNavEvents`, `getNavEventsSince`, `pruneOldEvents`)
- Added `chrome.webNavigation.onCommitted` listener in service-worker.ts to record navigation events
- DB opened/closed per write (service worker safe)
- Events pruned after 30 days via daily alarm
- Added `webNavigation` permission to manifest.json
- Typecheck and tests pass
---

## 2026-02-24 - INFRA-02
- Implemented tab switch affinity tracking via chrome.storage.local
- Files created: src/shared/affinityStorage.ts
- Files modified: src/shared/types.ts, src/background/service-worker.ts
- **Learnings for future iterations:**
  - chrome.storage.local.get() returns `Record<string, any>` — need explicit cast for typed arrays
  - Linter auto-converts `let` to `const` if no reassignment detected in same scope — use `let` only when reassignment is nearby
  - previousActiveTabId tracked as module-level variable in service worker for tab switch pairs
  - Affinity pairs use undirected keys (min:max) so A→B and B→A count together
  - Storage log capped at 10,000 entries to prevent unbounded growth
---

## Iteration 2 - Tue Feb 24 18:56:47 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-184955/iter-2.log
---
**INFRA-02 is complete.** There are still stories with `passes: false` remaining (US-T1-01 is next at priority 3).

**INFRA-02 Summary:**
- Added `TabSwitchEntry` interface to `types.ts` with `from`, `to`, `timestamp` fields
- Created `src/shared/affinityStorage.ts` with `recordSwitch()`, `getAffinityPairs(minCount)`, `pruneOldSwitches(maxAgeDays)`
- Storage key is `tabSwitchLog` in `chrome.storage.local`
- Added tab switch recording in `chrome.tabs.onActivated` listener in service-worker.ts using `previousActiveTabId` tracking
- Switch log capped at 10,000 entries
- Typecheck and tests pass
---

## 2026-02-24 - US-T1-01
- Implemented Time Machine settings: enable/disable tracking, retention period (7/14/30 days)
- Files modified: src/shared/types.ts, src/shared/constants.ts, src/sidepanel/SettingsPanel.tsx, src/background/service-worker.ts
- **Learnings for future iterations:**
  - Settings interface in types.ts must match DEFAULT_SETTINGS in constants.ts exactly
  - SettingsPanel uses `handleUpdate()` for partial settings updates — same pattern for all new settings
  - Toggle button styling: `bg-arc-accent` when enabled, `bg-gray-300 dark:bg-arc-surface-hover` when disabled
  - Prune alarm handler reads settings to get retention days, then passes to pruneOldEvents()
  - `getSettings()` is already imported in service-worker.ts — no additional import needed
---

## Iteration 3 - Tue Feb 24 19:00:16 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-184955/iter-3.log
---
**US-T1-01 is complete.** There are still stories with `passes: false` remaining (US-T1-02 is next at priority 4).

**US-T1-01 Summary:**
- Extended `Settings` interface with `timeMachineEnabled: boolean` and `timeMachineRetentionDays: number`
- Added `DEFAULT_SETTINGS` values: `timeMachineEnabled: true`, `timeMachineRetentionDays: 30`
- Added `TIME_MACHINE_RETENTION_OPTIONS` constant (7/14/30 days)
- Added Time Machine section to `SettingsPanel.tsx` with toggle and retention dropdown
- Service worker now checks `timeMachineEnabled` before recording navigation events
- Prune alarm handler reads `timeMachineRetentionDays` from settings
- Typecheck and tests pass
---

## 2026-02-24 - US-T1-02
- Implemented Navigation Tree Builder for Time Machine feature
- Files created: src/shared/timeMachineStorage.ts
- Files modified: src/shared/types.ts
- **Learnings for future iterations:**
  - Tree building chains events via referrerTabId; best parent is the most recent event on the referrer tab before the child's timestamp
  - getNavEventsSince() in navigationDb.ts returns all events from a timestamp onward; filter client-side for end bound
  - NavTreeNode is a recursive type — children sorted oldest-first for natural reading, roots sorted newest-first
  - Orphan events (no referrer or no matching parent) become root nodes
  - eventsByTabId map is key for efficient parent lookup during tree construction
---
