# Ralph Progress Log
Started: Tue Feb 24 18:49:55 IST 2026
---

## Codebase Patterns
- Storage: Chrome Storage API (chrome.storage.local) for most data; IndexedDB for large/frequent data (navigation events)
- Service worker opens/closes DB per write (no persistent connection — worker may suspend)
- Alarms registered in chrome.runtime.onInstalled, handled in chrome.alarms.onAlarm listener
- All alarm handlers use .catch(() => {}) for silent failure with retry on next alarm
- Message types defined as discriminated unions in types.ts (ServiceWorkerMessage, SidePanelMessage)
- crypto.randomUUID() available in service worker for generating IDs
- chrome.webNavigation.onCommitted fires before page title is available; title fetched via chrome.tabs.get()
- chrome.storage.local.get() returns Record<string, any> — cast results explicitly to avoid TS errors
- Tab switch tracking uses undirected pairs (A→B and B→A count together) for affinity
- Autopilot scoring: score = matchedConditions × rule.priority; all conditions must match for a rule to score
- Settings toggle pattern: use `handleUpdate({ field: !settings.field })` with toggle button styling from existing sections
- TIME_MACHINE_RETENTION_OPTIONS constant in constants.ts for dropdown (7/14/30 days)
- pruneOldEvents() in navigationDb.ts accepts optional maxAgeDays parameter (defaults to 30)
- Tree building: chain events via referrerTabId; best parent = most recent event on referrer tab before child's timestamp
- getNavEventsSince() returns all events from a timestamp; filter client-side for end bound
- Graph building: nodes keyed by URL, edges keyed by type:source|target; tabId→URL map built from sorted navEvents for resolving references
- Content scripts: each content script gets its own entry in manifest.json content_scripts array and its own vite entry point (content-xxx naming convention)
- IndexedDB for large data (nav events, page captures); chrome.storage.local for small data (annotations, settings, affinity)
- Content script annotations: use imperative DOM (no React), XPath for text location with fallbackScrollY, messages to service worker for persistence
- crypto.randomUUID() available in content scripts for generating annotation IDs
- Autopilot rules stored in chrome.storage.local under key `autopilotRules` (AutopilotRule[])
- Notification-based user confirmation: chrome.notifications.create with buttons, handle via onButtonClicked listener
- Autopilot switch uses 5-second delay timer (cancellable via notification button or AUTOPILOT_UNDO message)
- AI services: aiResearchService.ts has summarizePage(), connectPages(), generateBrief() — each reads API key from settings, enforces 2s rate limit
- Annotation rendering: XPath + textOffset + textLength for precise location; fallback to scrollY floating indicator when XPath fails
- Service worker GET_ANNOTATIONS uses sendResponse pattern (return true for async); content scripts use chrome.runtime.sendMessage with callback

## 2026-02-24 - INFRA-01
- Implemented IndexedDB-backed navigation event tracking system
- Files created: src/shared/navigationDb.ts
- Files modified: src/shared/types.ts, src/background/service-worker.ts, public/manifest.json
- **Learnings for future iterations:**
  - IndexedDB must be opened/closed per operation since service workers can suspend
  - chrome.webNavigation.onCommitted fires for subframes too — filter by frameId === 0
  - Page title not available at onCommitted time; need chrome.tabs.get() which may fail if tab closed
  - Skip chrome://, chrome-extension://, and about: URLs from tracking
  - Session ID is regenerated on service worker restart (using crypto.randomUUID())
---

## Iteration 1 - Tue Feb 24 18:53:49 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-184955/iter-1.log
---
INFRA-01 is complete. There are still stories with `passes: false` remaining (INFRA-02 is next at priority 2).

**INFRA-01 Summary:**
- Added `NavigationEvent` interface to `types.ts`
- Created `src/shared/navigationDb.ts` with IndexedDB wrapper (`initNavigationDb`, `addNavEvent`, `getNavEvents`, `getNavEventsSince`, `pruneOldEvents`)
- Added `chrome.webNavigation.onCommitted` listener in service-worker.ts to record navigation events
- DB opened/closed per write (service worker safe)
- Events pruned after 30 days via daily alarm
- Added `webNavigation` permission to manifest.json
- Typecheck and tests pass
---

## 2026-02-24 - INFRA-02
- Implemented tab switch affinity tracking via chrome.storage.local
- Files created: src/shared/affinityStorage.ts
- Files modified: src/shared/types.ts, src/background/service-worker.ts
- **Learnings for future iterations:**
  - chrome.storage.local.get() returns `Record<string, any>` — need explicit cast for typed arrays
  - Linter auto-converts `let` to `const` if no reassignment detected in same scope — use `let` only when reassignment is nearby
  - previousActiveTabId tracked as module-level variable in service worker for tab switch pairs
  - Affinity pairs use undirected keys (min:max) so A→B and B→A count together
  - Storage log capped at 10,000 entries to prevent unbounded growth
---

## Iteration 2 - Tue Feb 24 18:56:47 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-184955/iter-2.log
---
**INFRA-02 is complete.** There are still stories with `passes: false` remaining (US-T1-01 is next at priority 3).

**INFRA-02 Summary:**
- Added `TabSwitchEntry` interface to `types.ts` with `from`, `to`, `timestamp` fields
- Created `src/shared/affinityStorage.ts` with `recordSwitch()`, `getAffinityPairs(minCount)`, `pruneOldSwitches(maxAgeDays)`
- Storage key is `tabSwitchLog` in `chrome.storage.local`
- Added tab switch recording in `chrome.tabs.onActivated` listener in service-worker.ts using `previousActiveTabId` tracking
- Switch log capped at 10,000 entries
- Typecheck and tests pass
---

## 2026-02-24 - US-T1-01
- Implemented Time Machine settings: enable/disable tracking, retention period (7/14/30 days)
- Files modified: src/shared/types.ts, src/shared/constants.ts, src/sidepanel/SettingsPanel.tsx, src/background/service-worker.ts
- **Learnings for future iterations:**
  - Settings interface in types.ts must match DEFAULT_SETTINGS in constants.ts exactly
  - SettingsPanel uses `handleUpdate()` for partial settings updates — same pattern for all new settings
  - Toggle button styling: `bg-arc-accent` when enabled, `bg-gray-300 dark:bg-arc-surface-hover` when disabled
  - Prune alarm handler reads settings to get retention days, then passes to pruneOldEvents()
  - `getSettings()` is already imported in service-worker.ts — no additional import needed
---

## Iteration 3 - Tue Feb 24 19:00:16 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-184955/iter-3.log
---
**US-T1-01 is complete.** There are still stories with `passes: false` remaining (US-T1-02 is next at priority 4).

**US-T1-01 Summary:**
- Extended `Settings` interface with `timeMachineEnabled: boolean` and `timeMachineRetentionDays: number`
- Added `DEFAULT_SETTINGS` values: `timeMachineEnabled: true`, `timeMachineRetentionDays: 30`
- Added `TIME_MACHINE_RETENTION_OPTIONS` constant (7/14/30 days)
- Added Time Machine section to `SettingsPanel.tsx` with toggle and retention dropdown
- Service worker now checks `timeMachineEnabled` before recording navigation events
- Prune alarm handler reads `timeMachineRetentionDays` from settings
- Typecheck and tests pass
---

## 2026-02-24 - US-T1-02
- Implemented Navigation Tree Builder for Time Machine feature
- Files created: src/shared/timeMachineStorage.ts
- Files modified: src/shared/types.ts
- **Learnings for future iterations:**
  - Tree building chains events via referrerTabId; best parent is the most recent event on the referrer tab before the child's timestamp
  - getNavEventsSince() in navigationDb.ts returns all events from a timestamp onward; filter client-side for end bound
  - NavTreeNode is a recursive type — children sorted oldest-first for natural reading, roots sorted newest-first
  - Orphan events (no referrer or no matching parent) become root nodes
  - eventsByTabId map is key for efficient parent lookup during tree construction
---

## Iteration 1 - Tue Feb 24 19:09:10 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-190718/iter-1.log
---
**US-T1-02 is complete.** There are still stories with `passes: false` remaining (US-A-01 is next at priority 5).

**US-T1-02 Summary:**
- Added `NavTreeNode` interface to `types.ts`: `{ event: NavigationEvent, children: NavTreeNode[] }`
- Created `src/shared/timeMachineStorage.ts` with:
  - `buildNavigationTree(events)` — chains events via `referrerTabId`, orphans become roots, sorted newest-first
  - `getTreesForTimeRange(start, end)` — fetches from IndexedDB and builds trees for a time window
- Typecheck and tests pass
---

## 2026-02-24 - US-A-01
- Implemented Annotation data model and chrome.storage.local-backed storage layer
- Files created: src/shared/annotationStorage.ts
- Files modified: src/shared/types.ts
- **Learnings for future iterations:**
  - Annotation storage uses chrome.storage.local (not IndexedDB) — annotations are small, don't need indexing
  - Storage key is `annotations` — same pattern as other chrome.storage.local stores (tabSwitchLog, etc.)
  - saveAnnotation() does upsert — checks by id, updates if exists, appends if new
  - exportAnnotations() supports both JSON and Markdown formats; Markdown groups by page URL
  - Annotation interface has XPath + textOffset + textLength for precise text location, plus fallbackScrollY for when XPath fails
---

## Iteration 2 - Tue Feb 24 19:11:00 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-190718/iter-2.log
---
**US-A-01 is complete.** There are still stories with `passes: false` remaining (US-AP-01 is next at priority 6).

**US-A-01 Summary:**
- Added `Annotation` interface to `types.ts` with all required fields: id, url, pageTitle, type ('highlight' | 'note'), text, comment, color, xpath, textOffset, textLength, fallbackScrollY, createdAt
- Created `src/shared/annotationStorage.ts` with:
  - `saveAnnotation(a)` — upsert by id
  - `getAnnotationsForUrl(url)` — filter by URL
  - `deleteAnnotation(id)` — remove by id
  - `getAllAnnotations()` — return all
  - `exportAnnotations(format)` — JSON or Markdown export
- Storage key is `annotations` in `chrome.storage.local`
- Typecheck and tests pass
---

## 2026-02-24 - US-AP-01
- Implemented Autopilot Rules Data Model — interfaces and settings defaults
- Files modified: src/shared/types.ts, src/shared/constants.ts
- **Learnings for future iterations:**
  - AutopilotCondition uses a discriminated `type` field ('time' | 'domain' | 'displayCount') with a string `value` for flexibility
  - AutopilotRule has `priority` field for scoring engine to weight matched rules
  - Autopilot disabled by default (`autopilotEnabled: false`) but notifications enabled (`autopilotNotify: true`)
  - Settings interface and DEFAULT_SETTINGS must stay in sync — add to both simultaneously
---

## Iteration 1 - Tue Feb 24 19:12:18 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-191218/iter-1.log
---
Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.
⚠️  timeout failed with ITER_TIMEOUT='1200'. Running without timeout.
Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.
---

## Iteration 2 - Tue Feb 24 19:12:20 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-191218/iter-2.log
---
Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.
⚠️  timeout failed with ITER_TIMEOUT='1200'. Running without timeout.
Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.
---

## Iteration 3 - Tue Feb 24 19:12:23 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-191218/iter-3.log
---
Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.
⚠️  timeout failed with ITER_TIMEOUT='1200'. Running without timeout.
Error: Claude Code cannot be launched inside another Claude Code session.
Nested sessions share runtime resources and will crash all active sessions.
To bypass this check, unset the CLAUDECODE environment variable.
---

## 2026-02-24 - US-AP-02
- Implemented Autopilot Scoring Engine — pure-function evaluation of autopilot rules
- Files created: src/shared/autopilotEngine.ts
- Files modified: src/shared/types.ts
- **Learnings for future iterations:**
  - AutopilotContext interface has currentTime (Date), activeTabUrl (string), displayCount (number)
  - Time conditions use 'HH:MM-HH:MM' format and support cross-midnight ranges (e.g., '22:00-06:00')
  - Domain conditions support wildcard patterns ('*.example.com') and exact match
  - DisplayCount condition compares integer equality
  - All conditions must match for a rule to be scored (AND logic)
  - Score = matched condition count × rule priority; highest score wins
  - getBestMatch() returns null when no rules match (no enabled rules, no conditions, or no full match)
---

## Iteration 1 - Tue Feb 24 19:14:41 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-191248/iter-1.log
---
**US-AP-02 is complete.** There are still stories with `passes: false` remaining (US-G-01 is next at priority 8).

**US-AP-02 Summary:**
- Added `AutopilotContext` interface (`currentTime`, `activeTabUrl`, `displayCount`) and `ScoredRule` interface to `types.ts`
- Created `src/shared/autopilotEngine.ts` with:
  - `scoreRules(rules, context)` — evaluates all enabled rules, returns scored results sorted by score descending
  - `getBestMatch(rules, context)` — returns highest-scoring rule or null
- Time conditions support `HH:MM-HH:MM` format including cross-midnight ranges
- Domain conditions support wildcard patterns (`*.example.com`) and exact match
- DisplayCount conditions check integer equality
- All conditions must match (AND logic); score = matched count × rule priority
- Typecheck and tests pass
---

## 2026-02-24 - US-G-01
- Implemented Graph Data Builder — builds graph nodes + edges from navigation events and tab switch affinity
- Files created: src/shared/tabGraphStorage.ts
- Files modified: src/shared/types.ts
- **Learnings for future iterations:**
  - GraphNode uses URL as its ID (unique key for deduplication)
  - Nodes built from navEvents (visitCount) + openTabs (isOpen flag); open tabs always included even without nav events
  - Navigation edges built by tracking tabId→URL mapping over sorted events, then linking via referrerTabId
  - Switch edges built by resolving affinity pair tabIds to URLs using tabId→URL map or open tab URLs
  - Edges keyed by type:source|target to aggregate weights across multiple events
  - Nodes capped at 50 by highest visitCount
  - getDomain() uses URL constructor with try/catch for robustness
---

## Iteration 2 - Tue Feb 24 19:16:58 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-191248/iter-2.log
---
**US-G-01 is complete.** There are still stories with `passes: false` remaining (US-R-01 is next at priority 9).

**US-G-01 Summary:**
- Added `GraphNode`, `GraphEdge`, and `GraphData` interfaces to `types.ts`
- Created `src/shared/tabGraphStorage.ts` with `buildGraphData(navEvents, affinityPairs, openTabs)` function
- Nodes built from navigation events (visit counts) + open tabs (isOpen flag), capped at 50
- Navigation edges derived from referrerTabId chains; switch edges from affinity pairs
- Edges have correct type classification (`navigation` vs `switch`) with aggregated weights
- Typecheck and tests pass
---

## 2026-02-24 - US-R-01
- Implemented Research Mode Toggle & Page Text Capture
- Files created: src/shared/researchDb.ts, src/content/research.ts
- Files modified: src/shared/types.ts, public/manifest.json, vite.config.ts
- **Learnings for future iterations:**
  - Research data uses IndexedDB (like navigation events) since page text can be 50KB+ per capture
  - Content script is a no-op until triggered by CAPTURE_PAGE_TEXT message — keeps overhead zero
  - Content script returns text, title, and URL synchronously via sendResponse
  - Manifest needs separate content_scripts entry for research.ts (not bundled with capture.ts)
  - Vite config needs a separate entry point for each content script (content-research)
  - ResearchSession stores pageIds as string array; captures reference sessionId via index
  - deleteSession cascades to delete all associated page captures
---

## Iteration 3 - Tue Feb 24 19:20:07 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-191248/iter-3.log
---
**US-R-01 is complete.** There are still stories with `passes: false` remaining (US-A-02 is next at priority 10).

**US-R-01 Summary:**
- Added `PageCapture` interface (`id`, `url`, `title`, `text`, `sessionId`, `capturedAt`, `summary?`) and `ResearchSession` interface (`id`, `name`, `pageIds`, `createdAt`) to `types.ts`
- Extended `ServiceWorkerMessage` with `PAGE_TEXT_CAPTURED` type and `SidePanelMessage` with `CAPTURE_PAGE_TEXT` type
- Created `src/shared/researchDb.ts` with IndexedDB wrapper: `initResearchDb()`, `savePageCapture()`, `getCaptures(sessionId)`, `saveSession()`, `getSessions()`, `deleteSession(sessionId)` (cascades to captures)
- Created `src/content/research.ts` — no-op content script that extracts `document.body.innerText` only when triggered by `CAPTURE_PAGE_TEXT` message
- Registered research content script in `manifest.json` (all URLs, `document_idle`)
- Added `content-research` entry point to `vite.config.ts`
- Typecheck and tests pass
---

## 2026-02-24 - US-A-02
- Implemented Content Script Annotation Toolbar with floating toolbar on text selection
- Files created: src/content/annotate.ts
- Files modified: src/shared/types.ts, src/background/service-worker.ts, public/manifest.json, vite.config.ts
- **Learnings for future iterations:**
  - Floating toolbar positioned relative to selection bounding rect (fixed positioning, translateX(-50%) for centering)
  - XPath generation walks up DOM tree; text offset calculated via TreeWalker within parent element
  - Content script uses mouseup + debounce for selection detection (100ms delay)
  - Toolbar dismissed on mousedown outside via document-level listener
  - Note input replaces toolbar in-place (same position) with input + save button
  - SAVE_ANNOTATION and DELETE_ANNOTATION added to SidePanelMessage union type (content scripts use same message channel)
  - Service worker imports annotationStorage and calls saveAnnotation/deleteAnnotation directly
  - z-index 2147483647 (max 32-bit int) ensures toolbar is above all page content
---

## Iteration 1 - Tue Feb 24 19:29:13 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-192530/iter-1.log
---
**US-A-02 is complete.** There are still stories with `passes: false` remaining (US-AP-03 is next at priority 11).

**US-A-02 Summary:**
- Created `src/content/annotate.ts` — floating annotation toolbar that appears on text selection
  - 3 highlight color buttons: yellow (#FFEB3B), green (#81C784), blue (#64B5F6)
  - Note button opens inline text input for adding comments
  - XPath + fallbackScrollY captured for each annotation
  - Toolbar dismissed on click outside
- Extended `SidePanelMessage` with `SAVE_ANNOTATION` and `DELETE_ANNOTATION` message types in `types.ts`
- Added service worker handlers for `SAVE_ANNOTATION` and `DELETE_ANNOTATION` using `annotationStorage`
- Registered content script in `manifest.json` (all URLs, document_idle) and `vite.config.ts` (content-annotate entry)
- Typecheck and tests pass
---

## 2026-02-24 - US-AP-03
- Implemented Autopilot Background Worker — wired scoring engine into service worker with alarm-based evaluation
- Files modified: src/shared/types.ts, src/background/service-worker.ts, public/manifest.json
- **Learnings for future iterations:**
  - Autopilot rules stored in chrome.storage.local under key `autopilotRules` (AutopilotRule[])
  - chrome.notifications.create with buttons for user-facing confirmations; handle via onButtonClicked listener
  - 5-second cancellable delay before workspace switch (clearTimeout pattern)
  - autopilotPreviousWorkspaceId tracks last workspace for undo; cleared on successful undo or cancel
  - AUTOPILOT_SWITCH sent as ServiceWorkerMessage (service worker → sidepanel), AUTOPILOT_UNDO sent as SidePanelMessage (sidepanel → service worker)
  - evaluateAutopilot() is a no-op when autopilotEnabled is false or no rules exist
  - Display count retrieved via chrome.system.display.getInfo() for multi-monitor condition matching
---

## Iteration 2 - Tue Feb 24 19:33:01 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-192530/iter-2.log
---
**US-AP-03 is complete.** There are still stories with `passes: false` remaining (US-G-02 is next at priority 12).

**US-AP-03 Summary:**
- Extended `ServiceWorkerMessage` with `AUTOPILOT_SWITCH` (workspaceId + workspaceName) and `AUTOPILOT_UNDO` types
- Extended `SidePanelMessage` with `AUTOPILOT_UNDO` type
- Added `evaluateAutopilot` alarm (every 5 minutes) in `onInstalled`
- Implemented `evaluateAutopilot()` — loads rules from storage, builds context (time, active tab URL, display count), runs scoring engine, switches workspace if best match differs
- Notification shown before switching (if `autopilotNotify` enabled) with Cancel button
- 5-second cancellable delay before actual workspace switch
- `AUTOPILOT_UNDO` message handler reverts to previous workspace
- `notifications` permission added to `manifest.json`
- No-op when `autopilotEnabled` is false or no rules exist
- Typecheck and tests pass
---

## 2026-02-24 - US-G-02
- Implemented Graph Layout Hook with force-directed algorithm for SVG visualization
- Files created: src/sidepanel/useGraphLayout.ts
- Files modified: src/shared/types.ts
- **Learnings for future iterations:**
  - LayoutResult extends GraphNode/GraphEdge with position fields (x, y for nodes; x1, y1, x2, y2 for edges)
  - Force-directed layout uses repulsion between all pairs + attraction along edges, 100 iterations
  - useMemo with [data, width, height] deps ensures stable layout on re-render
  - Padding of 20px keeps nodes from canvas edges
  - computeLayout is a pure function extracted outside the hook for testability
  - Node positions initialized randomly; velocity damped at 0.9 per iteration for convergence
---

## Iteration 3 - Tue Feb 24 19:34:50 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-192530/iter-3.log
---
**US-G-02 is complete.** There are still stories with `passes: false` remaining (US-R-02 is next at priority 13).

**US-G-02 Summary:**
- Added `LayoutNode`, `LayoutEdge`, and `LayoutResult` interfaces to `types.ts` — extend `GraphNode`/`GraphEdge` with position fields
- Created `src/sidepanel/useGraphLayout.ts` with:
  - `useGraphLayout(data, width, height)` React hook returning `LayoutResult`
  - Force-directed algorithm: repulsion between all node pairs + attraction along edges
  - Runs 100 iterations synchronously on mount (via `useMemo`)
  - Nodes clamped within bounds with 20px padding
  - Velocity damped at 0.9 per iteration for stable convergence
- Typecheck and tests pass
---

## 2026-02-24 - US-R-02
- Implemented Auto-Summarization via AI using OpenRouter API
- Files created: src/shared/aiResearchService.ts
- Files modified: src/background/service-worker.ts
- **Learnings for future iterations:**
  - aiResearchService.ts follows same OpenRouter pattern as aiGroupingService.ts (same base URL, auth, model)
  - 2-second rate limiter enforced via module-level lastCallTime + waitForRateLimit() async helper
  - Page text truncated to 8000 chars for summarization to stay within token limits
  - Service worker handles CAPTURE_PAGE_TEXT by forwarding to active tab content script, then saving + summarizing
  - Capture broadcast to sidepanel twice: once immediately (no summary), once after AI summarization completes
  - summarizePage(), connectPages(), generateBrief() each read API key from settings independently
  - 30-second timeout for AI calls (longer than 10s used in grouping service, since summarization prompts are larger)
---

## Iteration 1 - Tue Feb 24 21:01:07 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-205724/iter-1.log
---
**US-R-02 is complete.** There are still stories with `passes: false` remaining (US-T1-03 is next at priority 14).

**US-R-02 Summary:**
- Created `src/shared/aiResearchService.ts` with:
  - `summarizePage(text)` — summarizes page content in 2-3 paragraphs
  - `connectPages(summaries)` — analyzes connections across multiple pages (themes, contradictions, gaps)
  - `generateBrief(summaries, topic)` — generates comprehensive research brief with Summary/Key Findings/Sources
- All functions follow the OpenRouter API pattern from `aiGroupingService.ts` (same base URL, auth, model)
- 2-second minimum gap between API calls enforced via rate limiter
- Service worker handles `CAPTURE_PAGE_TEXT` message: forwards to active tab content script, saves capture to IndexedDB, calls `summarizePage()`, stores summary alongside capture
- Broadcasts `PAGE_TEXT_CAPTURED` twice: immediately (no summary) and after AI summarization completes
- Handles API errors gracefully (logs error, does not crash)
- Typecheck and tests pass
---

## 2026-02-24 - US-T1-03
- Implemented Timeline View Section for Time Machine feature
- Files created: src/sidepanel/TimeMachineSection.tsx
- Files modified: src/sidepanel/App.tsx, src/sidepanel/commandRegistry.ts, src/sidepanel/commandRegistry.test.ts
- **Learnings for future iterations:**
  - Collapsible section pattern: `<section>` wrapper with toggle button, chevron icon with rotate-90, conditional content rendering
  - Date range selector uses pill buttons with `bg-arc-accent text-white` for active state
  - TreeNode component is recursive with `depth` prop for indentation (16px per level)
  - Expand/collapse default: depth < 2 starts expanded
  - getFaviconUrl uses `new URL(url).origin + /favicon.ico` pattern
  - Command registry: add callback param to both destructured params and type signature, update test's defaultHandlers
  - scrollIntoView with `behavior: "smooth"` for command palette scroll-to-section
  - getTreesForTimeRange returns NavTreeNode[] sorted newest-first
---

## Iteration 2 - Tue Feb 24 21:05:25 IST 2026
Tool: claude
Log: /Users/vaidhprakashchoudhary/Documents/Projects/Development/fun-projects/arc-flow/scripts/ralph/runs/20260224-205724/iter-2.log
---
**US-T1-03 is complete.** There are still stories with `passes: false` remaining (US-A-03 is next at priority 15).

**US-T1-03 Summary:**
- Created `src/sidepanel/TimeMachineSection.tsx` — collapsible sidebar section with:
  - Date range selector (Today / Yesterday / This Week)
  - Recursive tree nodes showing favicon + title (truncated) + time
  - Click tree node opens URL in new tab
  - Expand/collapse tree branches (depth < 2 expanded by default)
  - Reacts to `chrome.storage.onChanged` for live updates
  - Hidden when Time Machine is disabled in settings
- Added `TimeMachineSection` rendering in `App.tsx` (between Archive and Recently Closed)
- Registered "Time Machine" command in `commandRegistry.ts` with scroll-to-section action
- Updated test file with `onTimeMachine` handler
- Typecheck and tests pass
---

## 2026-02-24 - US-A-03
- Implemented Annotation Highlight Rendering on page load
- Files modified: src/content/annotate.ts, src/shared/types.ts, src/background/service-worker.ts
- **Learnings for future iterations:**
  - XPath resolution uses document.evaluate() with FIRST_ORDERED_NODE_TYPE for finding annotation targets
  - Text range finding walks text nodes with TreeWalker, accumulating offsets to find exact start position
  - surroundContents() can fail when range spans multiple elements — fallback extracts and reinserts via extractContents/insertNode
  - Fallback indicators use absolute positioning at fallbackScrollY with a colored bar on left margin
  - GET_ANNOTATIONS message uses sendResponse pattern (return true for async) — content script calls chrome.runtime.sendMessage with callback
  - SCROLL_TO_ANNOTATION listener in content script handles scroll-to + highlight pulse animation
  - Mark elements use `background-color: ${color}40` (25% opacity) + `border-bottom: 2px solid` for subtle highlighting
  - Note indicators rendered as inline emoji after mark element with vertical-align: super
---
